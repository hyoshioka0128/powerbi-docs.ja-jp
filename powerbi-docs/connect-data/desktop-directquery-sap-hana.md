---
title: Power BI での SAP HANA 用 DirectQuery
description: SAP HANA で DirectQuery を使用する場合の考慮事項
author: davidiseminger
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-desktop
ms.topic: how-to
ms.date: 04/10/2019
ms.author: davidi
LocalizationGroup: Connect to data
ms.openlocfilehash: f121d4fb4e60fc29ef887d27c148aa3063dcee82
ms.sourcegitcommit: eef4eee24695570ae3186b4d8d99660df16bf54c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/23/2020
ms.locfileid: "85223684"
---
# <a name="connect-to-sap-hana-data-sources-by-using-directquery-in-power-bi"></a>Power BI で DirectQuery を使用して SAP HANA データ ソースに接続する
**SAP HANA** データ ソースへは、**DirectQuery** を使用して直接接続することが可能です。 SAP HANA には 2 つの方法で接続できます。

* **SAP HANA を多次元ソースとして扱う (既定):** この場合の動作は、Power BI が SAP Business Warehouse や Analysis Services など、他の多次元ソースに接続するときの動作に似たものになります。 この設定で SAP HANA に接続すると、分析または計算ビューが 1 つ選択され、そのビューのすべてのメジャー、階層、属性がフィールド一覧に表示されます。 ビジュアルを作成すると、集計データが常に SAP HANA から取得されます。 これは推奨される方法であり、SAP HANA を利用する新しい DirectQuery レポートの既定の方法です。

* **SAP HANA をリレーショナル ソースとして扱う:** この場合、Power BI は SAP HANA をリレーショナル ソースとして扱います。 これにより、柔軟性が向上します。 この方法では、メジャーを想定どおりに確実に集計し、パフォーマンスの問題を回避するように注意する必要があります。

接続方法はグローバル ツール オプションによって決定されます。これは次の画像のように、 **[ファイル] > [オプションと設定]** 、 **[オプション] > [DirectQuery]** の順に選択し、 **[SAP HANA をリレーショナル ソースとして扱う]** オプションをオンにすることで設定します。 

![](media/desktop-directquery-sap-hana/directquery-sap-hana_01a.png)

SAP HANA をリレーショナル ソースとして扱うオプションは、SAP HANA を介して DirectQuery を使う "*新しい*" レポートに対して使われる方法を制御します。 現在のレポートの既存の SAP HANA 接続に影響を与えることはありません。開いている他のレポートの接続に影響を与えることもありません。 そのため、このオプションが現在選択されていない場合、 **[データを取得]** を使って SAP HANA に新しい接続を追加すると、その接続では SAP HANA が多次元ソースとして扱われます。 ただし、SAP HANA にも接続する別のレポートが開かれている場合、そのレポートは、"*作成時に*" 設定されたオプションに従って引き続き動作します。つまり、SAP HANA に接続しているすべてのレポートは、2018 年 2 月より前に作成された場合、SAP HANA は引き続きリレーショナル ソースとして扱われます。 

この 2 つの手法は動作が異なっており、既存のレポートの手法を切り替えることはできません。 

それでは 2 つの手法をそれぞれ詳しく見ていきましょう。

## <a name="treat-sap-hana-as-a-multi-dimensional-source-default"></a>SAP HANA を多次元ソースとして扱う (既定)

SAP HANA に対するすべての新規接続では、この接続方法が既定で使われ、SAP HANA を多次元ソースとして扱います。 SAP HANA への接続をリレーショナル ソースとして扱うには、 **[ファイル] > [オプションと設定] > [オプション] > [直接クエリ]** の順に選択し、 **[SAP HANA をリレーショナル ソースとして扱う]** チェック ボックスをオンにします。 この機能が**プレビュー**段階の間は、多次元手法で作成されたレポートは Power BI サービスに公開*できません*。公開すると、Power BI サービス内でレポートを開いたとき、エラーが発生します。  

多次元ソースとして SAP HANA に接続する場合は、次の考慮事項が適用されます。

* **データ取得ナビゲーター**では、SAP HANA ビューを 1 つ選択できます。 計測値や属性を個々に選択することはできません。 接続時にクエリは定義されません。データをインポートするときや、SAP HANA をリレーショナル ソースとして扱っているときに DirectQuery を使用するときとは異なります。 つまり、この接続方法を選択しているとき、SAP HANA SQL クエリを直接利用することはできません。

* 選択したビューのすべてのメジャー、階層、属性がフィールド一覧に表示されます。 

* ビジュアルでメジャーが使用されるとき、そのビジュアルに必要な集計レベルでメジャー値を取得するように、SAP HANA にクエリが実行されます。 そのため、非加法メジャー (カウンターや比率など) を扱うとき、すべての集計が SAP HANA により実行されます。それ以上の集計が Power BI によって実行されることはありません。 

* SAP HANA から正しい集計値が常に得られるように、特定の制約を課す必要があります。 たとえば、計算列を追加することはできません。同じレポート内で複数の SAP HANA ビューのデータを組み合わせることはできません。 

SAP HANA を多次元ソースとして扱うと、もう 1 つの "*リレーショナル*" 手法のような優れた柔軟性はなくなりますが、簡単になり、複雑な SAP HANA メジャーを扱うときでも確実に正しい集計値が得られ、通常、結果的にパフォーマンスが向上します。 

**[フィールド]** 一覧には、SAP HANA ビューのメジャー、属性、階層がすべて表示されます。 この接続手法で発生する次の動作に注意してください。

* 属性が少なくとも 1 つの階層に含まれるとき、その属性は既定で非表示になります。 ただし、必要であれば、フィールド一覧のコンテキスト メニューで **[非表示を表示]** を選択すると表示できます。 同じコンテキスト メニューから、必要に応じて、非表示を表示に変更できます。

* SAP HANA では、そのラベルとして別の属性を使用するように属性を定義できます。 たとえば、**Product** (値は 1、2、3...) では、そのラベルとして **ProductName** (値は Bike、Shirt、Gloves など) を使用できます。 この場合、**Product** という 1 つのフィールドがフィールド一覧に表示されます。その値は Bike、Shirt、Gloves などのラベルになりますが、並べ替えと一意性の決定はキー値 1、2、3 で行われます。 非表示列の **Product.Key** も作成されます。必要であれば、基礎となるキー値にアクセスできます。 

基になる SAP HANA ビューで定義されている変数が接続時に表示されて、必要な値を入力できます。 この値は後で変更できます。リボンから **[クエリを編集]** を選択し、表示されたドロップダウン メニューから **[パラメーターの管理]** を選択します。 

許可されるモデリング操作には、DirectQuery 使用時の一般的なケースよりも制約が多くなります。SAP HANA から常に正しい集計データが得られるようにする必要があるためです。 ただし、さまざまな追加や変更が可能です。たとえば、メジャーを定義したり、フィールドの名前を変更したり、フィールドを非表示にしたり、表示形式を定義したりできます。 このような変更はすべて更新時に保存され、SAP HANA ビューに行われた競合しない変更が適用されます。 

### <a name="additional-modeling-restrictions"></a>その他のモデリングの制限

DirectQuery を使用して SAP HANA に接続する (多次元ソースとして扱う) 場合のモデリング上のその他の主要な制限は次のとおりです。 

* **計算列のサポートがない:** 計算列を作成する機能は無効です。 これは、計算列を作成するグループ化とクラスタリングも使用できないことを意味します。
* **メジャーのその他の制限:** メジャーで使用できる、SAP HANA のサポート レベルを反映する DAX 式の制限がこの他にもあります。
* **リレーションシップ定義のサポートがない:** 1 つのレポート内では、1 つのビューにのみクエリを実行できます。そのため、リレーションシップ定義はサポートされていません。
* **データ ビューがない:** **[データ ビュー]** は、通常詳細レベル データをテーブルに表示します。 SAP HANA などの OLAP ソースの性質から、このビューは SAP HANA では使用できません。
* **列とメジャーの詳細は固定:** フィールド リストにある列とメジャーの一覧は、基になるソースによって固定されており、変更できません。 たとえば、列を削除したり、そのデータ型を変更したりできません (ただし、名前変更は可能です)。
* **DAX のその他の制限:** メジャーの定義で使用できる DAX には、ソースの制限と一致する制限がこの他にもあります。 たとえば、テーブルに集計関数は使用できません。

### <a name="additional-visualization-restrictions"></a>視覚エフェクトのその他の制限

DirectQuery を使用して SAP HANA に接続する (多次元ソースとして扱う) とき、ビジュアルには制約があります。 
* **列集計ができない:** ビジュアルでは列の集計を変更できません。常に *[集計しない]* です。

## <a name="treat-sap-hana-as-a-relational-source"></a>SAP HANA をリレーショナル ソースとして扱う 

リレーショナル ソースとしての SAP HANA に接続することを選択すると、いくつかの点で柔軟性が強化されます。 たとえば、計算列を作成したり、複数の SAP HANA ビューからデータを含めたり、生成されたテーブル間で関係を構築したりできます。 ただし、SAP HANA をこのように使用するとき、次のような結果が得られるように、接続の扱われ方について特定の側面を理解することが大切です。 

* SAP HANA ビューに非加算的な方法 (たとえば、単純な合計ではなく、個別のカウントまたは平均) が含まれているとき、結果が想定したものになります。
* 結果のクエリが効率的です。

**[データの取得]** または **[クエリ エディター]** で定義したクエリで集計を実行するとき、SQL Server など、リレーショナル ソースの動作を最初に確認することをお勧めします。 次の例では、 **[クエリ エディター]** で定義したクエリは、*ProductID* での平均価格を返しています。  

![](media/desktop-directquery-sap-hana/directquery-sap-hana_01.png)

データが (DirectQuery ではなく) Power BI にインポートされる場合、次の結果になります。

* データは、 **[クエリ エディター]** で作成したクエリで定義した集計レベルでインポートされます。 たとえば、製品ごとの平均価格です。 これでは、ビジュアルで使用できる *ProductID* と *AveragePrice* の 2 つの列を持つテーブルが作成されます。
* ビジュアルでは、それ以降のすべての (*Sum*、*Average*、 *Min* などの) 集約は、そのインポートされたデータに対して実行されます。 たとえば、ビジュアルに *AveragePrice* を含めると、既定で *Sum* 集計が使用され、各 *ProductID* の *AveragePrice* の合計 (この例では 13.67) が返されます。 これは、ビジュアルで使用される (*Min*、*Average* などの) すべての代替の集計関数にも当てはまります。 たとえば、*AveragePrice* の *Average* では、6.66、4、および 3 の平均である 4.56 が返されます。元の表の 6 つのレコードの *Price* の平均 (5.17) ではありません。
  
インポートの代わりに **DirectQuery** を使用した場合 (同じリレーショナル ソースで)、同じセマンティクスが当てはまり、結果はまったく同じになります。  

* 同じクエリの場合、データが実際にインポートされない場合でも、論理的に正確に同じデータがレポート層に表示されます。

* ビジュアルでは、それ以降の (*Sum*、*Average*、*Min* などの) すべての集約がクエリの論理テーブルに対して再度実行されます。 ここでも、*AveragePrice* の *Average* を含むビジュアルでは、同様に 4.56 が返されます。
  
それでは、接続をリレーショナル ソースとして扱うときの SAP HANA について考えてみましょう。 Power BI は SAP HANA の、メジャーを含むことができる*分析ビュー*と*計算ビュー*の両方で使用することができます。 しかしながら、SAP HANA のアプローチは、このセクションで先に紹介したものと同じ原則に従います。つまり、 **[データの取得]** または **[クエリ エディター]** に定義したクエリによって使用可能なデータが決定され、ビジュアル内のそれ以降のすべての集計はそのデータに対して行われます。これは、インポートと DirectQuery の両方に対しても同様です。  
ただし、SAP HANA の性質を考えた場合、最初の **[データの取得]** ダイアログまたは **[クエリ エディター]** で定義したクエリは常に集計クエリであり、一般に、実際に使用される集計が SAP HANA ビューによって定義されているメジャーを含みます。

上の SQL Server の例と同等なものとして、*ID*、*ProductID*、*DepotID* を含む SAP HANA ビュー、およびビューで *Average of Price* として定義されている *AveragePrice* を含むメジャーがあります。  
    
**[データの取得]** エクスペリエンスで **ProductID** と **AveragePrice** メジャー用の選択が行われた場合、それではその集計データを要求するビューに対するクエリが定義されています (上記の例では、簡単にするために SAP HANA SQL の構文と完全に一致しない疑似 SQL を使用しています)。 すると、ビジュアルで定義されている以降の集計は、このようなクエリの結果がさらに集計されます。 SQL Server の場合で説明したように、これはインポートおよび DirectQuery の両方の場合に当てはまります。 DirectQuery の場合、 **[データの取得]** または **[クエリ エディター]** からのクエリは SAP HANA に送信される 1 つのクエリのサブセレクト内で使用されます。したがって、これでは、さらなる集計の前に、すべてのデータは読み込まれません。  

これらのすべての考慮事項と動作では、SAP HANA で DirectQuery を使用するとき、重要な事項に従うことが要求されます。  

* SAP HANA のメジャーが非加算的である場合 (たとえば、単純な *Sum* *Min* または *Max* ではない場合)、ビジュアルで実行される以降のすべての集計では注意が必要です。

* **[データの取得]** または **[クエリ エディター]** では、必要なデータを取得するのに、必要な列のみを含める必要があります。それは、結果がクエリになるという事実が反映された、SAP HANA に送信可能な妥当なクエリである必要があります。 たとえば、以降のビジュアルで必要になる可能性があるという考えから、列を数十選択した場合、DirectQuery の単純なビジュアルのサブセレクトで使用されている集計クエリにも、それらの数十の行が含まれることを意味します。これは、通常パフォーマンスを低下させます。
  
例を見てみましょう。 次の例では、 **[データの取得]** ダイアログ ボックスで 5 つ列 (**CalendarQuarter**、**Color**、**LastName**、**ProductLine**、**SalesOrderNumber**) をメジャー *OrderQuantity* と共に選択した場合、後で作成する Min OrderQuantity を含む単純なビジュアルには、次の SAP HANA への SQL クエリが含まれることを意味します。 灰色の部分は、 **[データの取得]**  /  **[クエリ エディター]** からのクエリを含むサブセレクトです。 このサブセレクトにより結果のカーディナリティが多くなる場合、結果の SAP HANA のパフォーマンスが低下する可能性があります。  

![](media/desktop-directquery-sap-hana/directquery-sap-hana_03.png)

   
この動作のため、 **[データの取得]** または **[クエリ エディター]** で選択するアイテムは、それが結果として SAP HANA で妥当なクエリとなる、必要なもののみに制限することをお勧めします。  

## <a name="best-practices"></a>ベスト プラクティス 

SAP HANA に接続するためのいずれの手法でも、DirectQuery の使用に関する推奨事項は SAP HANA にも適用されます。特に、良好なパフォーマンスの確保に関連するものに適用されます。 これらの推奨事項の詳細は、「[Power BI で DirectQuery を使用する](desktop-directquery-about.md)」という記事を参照してください。
   
## <a name="limitations"></a>制限事項

次の一覧は、完全にサポートされていないか、Power BI を使用した場合に異なる動作をする SAP HANA の機能をすべてまとめたものです。 

* **親子階層** - 親子階層は Power BI に表示されません。
これは、Power BI が SQL インターフェイスを利用して SAP HANA にアクセスするためです。親子階層には SQL 経由では完全にアクセスできません。
* **その他の階層メタデータ** - 階層の基本構造が Power BI に表示されますが、一部の階層メタデータ (不均衡階層の動作制御など) には効力がありません。
繰り返しになりますが、これは SQL インターフェイスによって課される制限に起因します。
* **SSL を使用した接続** - SSL と共にインポートと多次元を使用して接続できますが、リレーショナル コネクタに SSL を使用するように構成された SAP HANA インスタンスに接続することはできません。
* **属性ビューのサポート** - Power BI は分析ビューと計算ビューに接続できるが、属性ビューには直接接続できません。
* **カタログ オブジェクトのサポート** - Power BI はカタログ オブジェクトに接続できません。
* **公開後、変数に変更する** - レポートの公開後、Power BI で直接、SAP HANA 変数の値を変更することはできません。 
 
## <a name="known-issues"></a>既知の問題 
次の一覧は、Power BI を使用して SAP HANA (DirectQuery) に接続するときに発生する既知の問題をまとめたものです。 

* **Counters やその他のメジャーについてクエリを実行するときの SAP HANA の問題** - 分析ビューに接続しているとき、Counter メジャーやその他の比率メジャーが同じビジュアルに含まれている場合、SAP HANA から間違ったデータが返されます。 これは SAP ノート 2128928 で取り上げられています (計算列と Counter にクエリを実行すると、予想外の結果が返される)。 この場合、比率メジャーが正しくなくなります。 

* **1 つの SAP HANA 列から複数の Power BI 列** - 一部の計算ビューで、複数の階層で 1 つの SAP HANA 列が使用されるとき、SAP HANA はこれを 2 つの別々の属性として表示します。 結果的に、Power BI で 2 つの列が生成されます。  ただし、このような列は既定で非表示になります。階層を伴うか、列を直接伴うクエリはすべて正しく動作します。 
 
## <a name="next-steps"></a>次のステップ

DirectQuery の詳細については、次のリソースを参照してください。

* [Power BI の DirectQuery](desktop-directquery-about.md)
* [DirectQuery でサポートされるデータ ソース](power-bi-data-sources.md)
* [DirectQuery と SAP BW](desktop-directquery-sap-bw.md)
* [オンプレミス データ ゲートウェイ](service-gateway-onprem.md)
