---
title: Power BI Desktop での行レベルのセキュリティ (RLS) のガイダンス
description: Power BI Desktop のデータ モデルで行レベルのセキュリティ (RLS) を適用するためのガイダンスです。
author: peter-myers
ms.reviewer: asaxton
ms.service: powerbi
ms.subservice: powerbi-desktop
ms.topic: conceptual
ms.date: 06/18/2020
ms.author: v-pemyer
ms.openlocfilehash: 60bb1ef7421d4ebcedd49d2e973cf245edec0381
ms.sourcegitcommit: cff93e604e2c5f24e0f03d6dbdcd10c2332aa487
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/22/2020
ms.locfileid: "90965034"
---
# <a name="row-level-security-rls-guidance-in-power-bi-desktop"></a>Power BI Desktop での行レベルのセキュリティ (RLS) のガイダンス

この記事は、Power BI Desktop を操作するデータ モデラーを対象としています。 データ モデルで行レベルのセキュリティ (RLS) を適用するための適切な設計方法について説明します。

RLS では "_テーブルの行_" のフィルター処理が行われるということを理解しておくことが重要です。 テーブル、列、メジャーなどのモデル オブジェクトへのアクセスを制限するように構成することはできません。

> [!NOTE]
> この記事では、RLS について、またはそれを設定する方法については説明しません。 詳細については、「[Power BI Desktop の行レベルのセキュリティを使用してデータ アクセスを制限する](../create-reports/desktop-rls.md)」を参照してください。
>
> また、Azure Analysis Services または SQL Server Analysis Services によって外部でホストされているモデルへのライブ接続での RLS の適用についても説明しません。 これらの場合には、RLS は Analysis Services によって適用されます。 Power BI がシングル サインオン (SSO) を使用して接続しているときは、Analysis Services によって RLS が適用されます (アカウントに管理者特権がない場合)。

## <a name="create-roles"></a>ロールを作成する

複数のロールを作成することができます。 1 人のレポート ユーザーに必要なアクセス許可を検討する場合は、レポート ユーザーが複数のロールのメンバーになるように設計するのではなく、できる限りすべてのアクセス許可を付与する 1 つのロールを作成するようにします。 これは、レポート ユーザーは、ユーザー アカウントを使用して直接、またはセキュリティ グループのメンバーシップによって間接的に、複数のロールにマップする可能性があるためです。 複数のロールにマッピングすると、予期しない結果になる可能性があります。

レポート ユーザーが複数のロールに割り当てられていると、RLS フィルターは加法的になります。 つまり、レポート ユーザーは、それらのフィルターの和集合を表すテーブル行を見ることができます。 さらに、場合によっては、レポート ユーザーにテーブルの行が表示されないことを保証することができません。 したがって、SQL Server のデータベース オブジェクトに適用されるアクセス許可 (およびその他のアクセス許可モデル) とは異なり、"一度拒否したら常に拒否する" の原則は適用されません。

2 つのロールを持つモデルを考えてみます。**Workers** という名前の 1 つ目のロールでは、次のルール式を使用して、**Payroll** テーブルのすべての行に対するアクセスが制限されます。

```dax
FALSE()
```

> [!NOTE]
> 式が **false** と評価されると、ルールからテーブル行は返されません。

一方、**Managers** という名前の 2 つ目のロールでは、次のルール式を使用して、**Payroll** テーブルのすべての行に対するアクセスが許可されます。

```dax
TRUE()
```

注意してください。レポート ユーザーが両方のロールにマップされると、**Salary** テーブルのすべての行が表示されるようになります。

## <a name="optimize-rls"></a>RLS を最適化する

RLS は、すべての DAX クエリにフィルターを自動的に適用することによって機能します。これらのフィルターは、クエリのパフォーマンスに悪影響を及ぼす可能性があります。 したがって、RLS が効率的であれば、適切なモデル設計になります。 次の記事で説明されているように、モデルの設計ガイダンスに従うことが重要です。

- [Power BI のスター スキーマおよび重要性について](star-schema.md)
- 「[Power BI ガイダンスのドキュメント](./index.yml)」に記載されているすべてのリレーションシップ ガイダンスの記事

通常、ファクト型テーブルではなく、ディメンション型テーブルに RLS フィルターを適用する方が効率的です。 また、RLS フィルターが他のモデル テーブルに確実に反映されるためには、リレーションシップが適切に設計されている必要があります。 そのため、モデルのリレーションシップで同じ結果になる可能性がある場合は、[LOOKUPVALUE](/dax/lookupvalue-function-dax) DAX 関数を使用しないようにします。

DirectQuery テーブルに対して RLS フィルターが適用されていて、他の DirectQuery テーブルに対するリレーションシップがある場合は常に、ソース データベースを最適化します。 それには、適切なインデックスの設計や、保存される計算列の使用が含まれる場合があります。 詳細については、「[Power BI Desktop の DirectQuery モデルのガイダンス](directquery-model-guidance.md)」を参照してください。

### <a name="measure-rls-impact"></a>RLS の影響を測定する

[パフォーマンス アナライザー](../create-reports/desktop-performance-analyzer.md)を使用することにより、Power BI Desktop での RLS フィルターのパフォーマンスへの影響を測定できます。 まず、RLS が適用されていない状態で、レポートの視覚化クエリの時間を確認します。 次に、 **[モデリング]** リボン タブの **[表示方法]** コマンドを使用して RLS を適用し、クエリの時間を確認して比較します。

## <a name="configure-role-mappings"></a>ロールのマッピングを構成する

Power BI にパブリッシュした後は、メンバーをデータセットのロールにマップする必要があります。 メンバーをロールに追加できるのは、データセット所有者またはワークスペース管理者だけです。 詳細については、「Power BI での行レベルのセキュリティ (RLS)」の「[モデルのセキュリティの管理](../admin/service-admin-rls.md#manage-security-on-your-model)」を参照してください。

メンバーにできるのは、ユーザー アカウントまたはセキュリティ グループです。 可能な限り、セキュリティ グループをデータセットのロールにマップすることをお勧めします。 これには、Azure Active Directory でのセキュリティ グループ メンバーシップの管理が含まれます。 場合によっては、タスクをネットワーク管理者に委任します。

## <a name="validate-roles"></a>ロールを検証する

各ロールをテストして、モデルが正しくフィルター処理されることを確認します。 これは、 **[モデリング]** リボン タブの **[表示方法]** コマンドを使用して簡単に行うことができます。

モデルに [USERNAME](/dax/username-function-dax) DAX 関数を使用する動的なルールがある場合は、予期される値 "_および予期されない_" 値について必ずテストします。 Power BI コンテンツを埋め込む場合 (具体的には[アプリ所有データ](../developer/embedded/embedding.md#embedding-for-your-customers)のシナリオ)、アプリのロジックで任意の値を有効な ID ユーザー名として渡すことができます。 可能な場合は常に、誤った値や悪意のある値に対しては行が返されないフィルターになるようにします。

Power BI Embedded を使用する例を考えます。アプリでは、ユーザーのジョブ ロールを有効なユーザー名として渡します: "Manager" または "Worker" のいずれかです。 マネージャーはすべての行を表示できますが、ワーカーは **Type** 列の値が "Internal" である行しか表示できません。

次のルール式が定義されています。

```dax
IF(
    USERNAME() = "Worker",
    [Type] = "Internal",
    TRUE()
)
```

このルール式の問題点は、"Worker" を除くすべての値に対して "_すべてのテーブル行_" が返されることです。 そのため、誤って "Wrker" などの値を指定すると、すべてのテーブル行が誤って返されます。 したがって、予想される値ごとにテストする式を記述する方が安全です。 次の改善されたルール式では、予期しない値に対してはテーブルから行が返されません。

```dax
IF(
    USERNAME() = "Worker",
    [Type] = "Internal",
    IF(
        USERNAME() = "Manager",
        TRUE(),
        FALSE()
    )
)
```

## <a name="design-partial-rls"></a>部分的な RLS を設計する

場合によっては、RLS フィルターによって制約されない値が計算で必要になることがあります。 たとえば、レポートで、"_全収益_" に対するレポート ユーザーの販売地域での収益の比率を表示することが必要な場合があります。

DAX 式で RLS をオーバーライドすることはできませんが (実際、RLS が適用されているかどうかを判断することさえできません)、概要モデル テーブルを使用できます。 "すべての地域" の収益を取得するには、概要モデル テーブルのクエリを行い、RLS フィルターでは制約されません。

この設計要件を実装する方法を見てみましょう。 まず、次のようなモデル設計を考えます。

:::image type="content" source="media/rls-guidance/mixed-rls-model.png" alt-text="モデルの図が示されている。後の段落で説明されている。":::

モデルは、次の 4 つのテーブルで構成されます。

- **Salesperson** テーブルには、営業担当者ごとに 1 つの行が格納されます。 **EmailAddress** 列には、各営業担当者のメール アドレスが格納されます。 このテーブルは非表示です。
- **Sales** テーブルには、注文ごとに 1 つの行が格納されます。 それには **Revenue % All Region** メジャーが含まれており、全地域の収益に対するレポート ユーザーの地域の収益の比率を返すように設計されています。
- **Date** テーブルには、日付ごとに 1 つの行が格納され、年と月でのフィルター処理とグループ化が可能です。
- **SalesRevenueSummary** は計算テーブルです。 注文日ごとの合計収益が格納されます。 このテーブルは非表示です。

次の式では、**SalesRevenueSummary** 計算テーブルが定義されています。

```dax
SalesRevenueSummary =
SUMMARIZECOLUMNS(
    Sales[OrderDate],
    "RevenueAllRegion", SUM(Sales[Revenue])
)
```

> [!NOTE]
> [集計テーブル](../transform-model/desktop-aggregations.md)でも、同じ設計要件を実現できます。

**Salesperson** テーブルには、次の RLS ルールが適用されます。

```dax
[EmailAddress] = USERNAME()
```

次の表では、3 つのモデル リレーションシップについて説明します。

|リレーションシップ|Description|
|---------|---------|
|![フローチャート ターミネータ 1。](media/common/icon-01-red-30x30.png)|**Salesperson** テーブルと **Sales** テーブルの間には、多対多のリレーションシップがあります。 RLS ルールにより、[USERNAME](/dax/username-function-dax) DAX 関数を使用して、非表示の **Salesperson** テーブルの **EmailAddress** 列がフィルター処理されます。 **Region** 列の (レポート ユーザーに対する) 値が、**Sales** テーブルに反映されます。|
|![フローチャート ターミネータ 2。](media/common/icon-02-red-30x30.png)|**Date** テーブルと **Sales** テーブルの間には、一対多のリレーションシップがあります。|
|![フローチャート ターミネータ 3。](media/common/icon-03-red-30x30.png)|**Date** テーブルと **SalesRevenueSummary** テーブルの間には、一対多のリレーションシップがあります。|

次の式では、**Revenue % All Region** メジャーが定義されています。

```dax
Revenue % All Region =
DIVIDE(
    SUM(Sales[Revenue]),
    SUM(SalesRevenueSummary[RevenueAllRegion])
)
```

> [!NOTE]
> 機密性のファクトが公開されないように注意してください。 この例に地域が 2 つしかない場合、レポート ユーザーは他の地域の収益を計算することができます。

## <a name="avoid-using-rls"></a>RLS の使用を避ける

そうすることに意味がある場合は常に、RLS を使用しないようにします。 静的フィルターを適用する少数の非常に単純な RLS ルールしかない場合は、代わりに複数のデータセットを公開することを検討します。 各データセットには、同じデータ アクセス許可を持つ特定のレポート対象ユーザーのデータが含まれているため、どのデータセットにもロールは定義されていません。 そして、対象ユーザーごとに 1 つのワークスペースを作成し、ワークスペースまたはアプリにアクセス許可を割り当てます。

たとえば、販売地域が 2 つだけの会社では、"_各販売地域に対する_" データセットを異なるワークスペースに公開します。 データセットでは RLS を適用しません。 ただし、[クエリ パラメーター](/power-query/power-query-query-parameters)を使用して、ソース データのフィルター処理を行います。 これにより、データセット パラメーターの値だけが異なる同じモデルが、各ワークスペースに対して公開されます。 営業担当者には、ワークスペース (または公開されたアプリ) の 1 つのみに対するアクセス権が割り当てられます。

RLS を避けることにはいくつかの長所があります。

- **クエリのパフォーマンスが向上する:** フィルターが減るため、パフォーマンスが向上する可能性があります。
- **モデルが小さくなる:** モデルの数は多くなりますが、サイズは小さくなります。 モデルが小さいと、クエリとデータ更新の応答性が向上します。ホスティングのための容量によってリソースに負荷がかかっている場合は特にそうです。 また、容量によって課せられるサイズ制限よりモデルのサイズを小さくしておくのも簡単です。 最後に、異なる容量にワークスペースを作成したり、ワークスペースを移動したりできるため、異なる容量間でワークロードのバランスを取るのが簡単になります。
- **機能が増える:** [Web への発行](../collaborate-share/service-publish-to-web.md)のような、RLS では動かない Power BI の機能を使用できます。

ただし、RLS を避けると短所もあります。

- **ワークスペースが複数になる:** レポート対象ユーザーごとに 1 つのワークスペースが必要です。 アプリが公開される場合は、レポート対象ユーザーごとに 1 つのアプリがあることも意味します。
- **内容が重複する:** ワークスペースごとにレポートとダッシュボードを作成する必要があります。 そのため、設定と保守に追加の作業と時間が必要です。
- **高い特権を持つユーザー:** 複数のレポート対象ユーザーに属する高い特権を持つユーザーは、データの統合ビューを表示できません。 複数のレポートを開く必要があります (別のワークスペースまたはアプリから)。

## <a name="troubleshoot-rls"></a>RLS のトラブルシューティング

RLS で予期しない結果が発生する場合は、次の問題を調べます。

- モデル テーブルの間に、列マッピングとフィルターの方向に関して正しくないリレーションシップが存在します。
- **[両方向にセキュリティ フィルターを適用する]** リレーションシップ プロパティが、正しく設定されていません。 詳細については、「[双方向のリレーションシップのガイダンス](relationships-bidirectional-filtering.md)」をご覧ください。
- テーブルにデータが含まれていません。
- テーブルに無効な値が読み込まれています。
- ユーザーが複数のロールにマップされています。
- モデルに集計テーブルが含まれており、集計と詳細で RLS ルールによるフィルター処理が一致していません。 詳細については、「Power BI Desktop で集計を使用する」の「[集計の RLS](../transform-model/desktop-aggregations.md#rls-for-aggregations)」を参照してください。

特定のユーザーがデータを表示できない場合、UPN が格納されていないか、正しく入力されていない可能性があります。 名前の変更の結果としてユーザー アカウントが変更されたため、突然発生する可能性があります。

> [!TIP]
> テストするには、[USERNAME](/dax/username-function-dax) DAX 関数を返すメジャーを追加します。 "Who Am I" のような名前を指定します。 次に、レポートのカード視覚化にメジャーを追加し、Power BI に発行します。

特定のユーザーがすべてのデータを表示できる場合は、ワークスペース内のレポートに直接アクセスしていて、データセットの所有者である可能性があります。 RLS は、次の場合にのみ適用されます。

- レポートがアプリで開かれています。
- レポートがワークスペースで開かれ、ユーザーが[ビューアー ロール](../collaborate-share/service-new-workspaces.md#roles-in-the-new-workspaces)にマップされています。

## <a name="next-steps"></a>次の手順

この記事に関する詳細については、次のリソースを参照してください。

- [Power BI での行レベルのセキュリティ (RLS)](../admin/service-admin-rls.md)
- [Power BI Desktop の行レベルのセキュリティを使用してデータ アクセスを制限する](../create-reports/desktop-rls.md)
- [Power BI Desktop でのモデル リレーションシップ](../transform-model/desktop-relationships-understand.md)
- わからないことがある場合は、 [Power BI コミュニティで質問してみてください](https://community.powerbi.com/)。
- Power BI チームへのご提案は、 [Power BI を改善するためのアイデアをお寄せください](https://ideas.powerbi.com/)